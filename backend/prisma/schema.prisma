// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Super Admin (gestiona toda la plataforma)
// ============================================
model SuperAdmin {
  id         String   @id @default(uuid())
  email      String   @unique
  password   String
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("super_admins")
}

// ============================================
// Configuración global del SaaS
// ============================================
model SaasConfig {
  id                   String   @id @default(uuid())
  monthly_price        Float    @default(50.0) // Precio base mensual por gym
  trial_days           Int      @default(30)
  max_members_per_plan Int      @default(100)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("saas_config")
}

// ============================================
// Gimnasio (tenant)
// ============================================
model Gym {
  id                String    @id @default(uuid())
  name              String
  slug              String    @unique // Para URL: /olimpo/admin
  email             String
  phone             String?
  address           String?
  logo_url          String?
  is_active         Boolean   @default(true)
  setup_completed   Boolean   @default(false)
  trial_ends_at     DateTime?
  subscription_ends DateTime?
  telegram_bot_token String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relaciones
  users        User[]
  members      Member[]
  disciplines  Discipline[]
  pricing_plans PricingPlan[]
  memberships  Membership[]
  attendances  Attendance[]
  notifications NotificationLog[]
  invoices     GymInvoice[]

  @@map("gyms")
}

// ============================================
// Usuario del gym (admin, recepcionista, entrenador)
// ============================================
enum UserRole {
  ADMIN
  RECEPTIONIST
  TRAINER
}

model User {
  id         String   @id @default(uuid())
  gym_id     String
  email      String
  password   String
  name       String
  role       UserRole
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relaciones
  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@unique([gym_id, email])
  @@map("users")
}

// ============================================
// Cliente/Member del gym
// ============================================
model Member {
  id                String    @id @default(uuid())
  gym_id            String
  code              String    @unique // GYM-001, GYM-002
  name              String
  email             String?
  phone             String
  birth_date        DateTime?
  address           String?
  emergency_contact String?
  photo_url         String?
  telegram_chat_id  String?
  is_active         Boolean   @default(true)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relaciones
  gym          Gym          @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  memberships  Membership[]
  attendances  Attendance[]

  @@unique([gym_id, phone])
  @@map("members")
}

// ============================================
// Disciplina (Gym, Crossfit, Funcional, etc.)
// ============================================
model Discipline {
  id          String   @id @default(uuid())
  gym_id      String
  name        String
  description String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relaciones
  gym           Gym           @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  pricing_plans PricingPlan[]
  memberships   Membership[]

  @@unique([gym_id, name])
  @@map("disciplines")
}

// ============================================
// Plan de precios
// ============================================
model PricingPlan {
  id            String   @id @default(uuid())
  gym_id        String
  discipline_id String
  num_people    Int      // 1, 2, 3, etc.
  num_months    Int      // 1, 3, 6, 12
  price         Float
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relaciones
  gym        Gym        @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [discipline_id], references: [id], onDelete: Cascade)

  @@unique([gym_id, discipline_id, num_people, num_months])
  @@map("pricing_plans")
}

// ============================================
// Membresía (inscripción/pago)
// ============================================
enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model Membership {
  id            String           @id @default(uuid())
  gym_id        String
  member_id     String
  discipline_id String
  status        MembershipStatus @default(ACTIVE)
  start_date    DateTime
  end_date      DateTime
  amount_paid   Float
  payment_method String? // efectivo, transferencia, etc.
  notes         String?
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  // Relaciones
  gym        Gym        @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  member     Member     @relation(fields: [member_id], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [discipline_id], references: [id], onDelete: Cascade)

  @@map("memberships")
}

// ============================================
// Asistencia (check-in por QR)
// ============================================
model Attendance {
  id         String   @id @default(uuid())
  gym_id     String
  member_id  String
  checked_at DateTime @default(now())
  notes      String?

  // Relaciones
  gym    Gym    @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  member Member @relation(fields: [member_id], references: [id], onDelete: Cascade)

  @@map("attendances")
}

// ============================================
// Log de notificaciones enviadas
// ============================================
enum NotificationType {
  WELCOME
  EXPIRING_7_DAYS
  EXPIRING_3_DAYS
  EXPIRED
}

model NotificationLog {
  id          String           @id @default(uuid())
  gym_id      String
  member_id   String?
  type        NotificationType
  message     String
  sent_at     DateTime         @default(now())
  success     Boolean          @default(true)
  error_msg   String?

  // Relaciones
  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@map("notification_logs")
}

// ============================================
// Factura mensual del gym (SaaS billing)
// ============================================
enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model GymInvoice {
  id             String        @id @default(uuid())
  gym_id         String
  amount         Float
  status         InvoiceStatus @default(PENDING)
  period_start   DateTime
  period_end     DateTime
  due_date       DateTime
  paid_at        DateTime?
  payment_method String?
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  // Relaciones
  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@map("gym_invoices")
}
